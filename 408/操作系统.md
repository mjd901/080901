# 操作系统

## 概述

### 概念、特征、功能

#### 操作系统的概念

计算机系统中的软件通常分为**系统软件**和**应用软件**两大类。

应用软件是指计算机用户利用计算机的软件、硬件资源为某一专门的应用目的开发的软件。例如，科学计算、工程设计、数据处理、事务处理和过程控制等方面的软件，以及文字处理软件、表格处理软件、辅助设计软件和实时处理软件等。

系统软件是计算机系统的一部分，由它支持应用软件的运行。常用的系统软件有**操作系统、语言处理程序、链接程序、诊断程序和数据库管理系统**等。

**操作系统是计算机系统中必不可少的核心系统软件，控制和管理整个计算机系统的硬件和软件资源，是用户和计算机之间的接口。**



#### 操作系统的特征

**操作系统是伴随着多道程序技术而出现的。**

**并发**：两个或者多个事件在**同一时间间隔内发生**。宏观上时同时发生的，微观上是交替进行的。

**并行**：两个或者多个事件在**同一时刻同时发生**。

作为一种系统软件，操作系统有**并发性、共享性、虚拟性、异步性的特征**。

1. **并发性**：计算机中同时运行着多个程序，这些程序宏观上看是同时运行，但微观上是交替运行。
   1. **单核CPU宏观上有多道程序同时执行，而微观上每一个时刻仅能执行一道程序，是交替发生的**。
   2. 多核CPU可以同时执行多个程序，多个程序可以**并行**。

2. **共享性**：共享指系统中的资源在一个时间段内可被多个并发执行的进程使用。
   1. **互斥共享方式**：一个时间段内，只允许一个进程访问该资源。
   2. **同时共享方式**：同时共享允许多个进程同时访问资源，如QQ和微信同时发送文件。这种情况下，进程可能会交替访问资源，如QQ和微信交替读取硬盘中的文件数据。

3. **虚拟性**：
   1. 虚拟存储器技术通过将物理内存对应为逻辑上的大内存，使得用户看到的内存容量远大于实际物理内存容量。**使用了虚拟技术中的空分复用技术**。
   2. 虚拟处理器技术让用户感受到多个CPU同时在服务，实际上是通过微小时间片的切换实现的，支持单核CPU上多个程序的并发执行。**使用了虚拟技术中的时分复用技术**。

4. **异步性**：异步性指多道程序环境下，由于资源有限，进程的执行不是一贯到底，而是走走停停，以不可预知的速度向前推进。

> 并发性和共享性是操作系统中两个互为存在条件的基本特征。没有并发性，共享性失去意义；没有共享性，并发性无法实现。



#### 操作系统的功能

**从用户和计算机之间的接口的观点来看，操作系统向上层提供的服务：GUI图形化用户接口、联机命令接口（终端）、脱机命令接口（.bat）、程序接口（编写代码中的系统调用）。**

从控制和管理整个计算机系统的硬件和软件资源的观点来看，操作系统的功能可以分为**进程管理(处理机管理)、存储管理、文件管理、设备管理和作业管理(命令接口)**5大部分。操作系统的5大部分通过相互配合、协调工作，以实现对计算机系统中资源的管理，控制任务的运行。

1. **进程管理**：实质是对处理器管理，主要任务是对进程的控制、同步、通信以及调度。
2. **存储管理**：主要任务是管理计算机内存资源。
3. **文件管理**：主要任务是有效地支持文件的存储、检索和修改等操作。
4. **设备管理**：对所有输入、输出设备的管理。
5. **接口管理**：命令接口、程序接口、图形接口。

从操作系统是计算机系统中必不可少的核心系统软件的观点来看，操作系统是对硬件机器的扩展，把计算机从裸机变为虚拟机。



### 操作系统的发展与分类

#### 操作系统的发展

操作系统从最初20世纪50年代的**手工操作**阶段，到早期的**批处理程序，再到多道批处理系统（操作系统开始出现）、分时系统、实时系统**，以及到了我们现在的的个人操作系统、网络操作系统、分布式操作系统、嵌入式操作系统、智能卡操作系统等，经历了较复杂的发展的历程。

在**手工操作阶段**，程序员通过在纸带上打孔的方式编写程序，程序运行结果通过纸带机输出，过程缓慢，且用户独占全机，资源利用率极低。随着**单道批处理系统**的引入，脱机输入输出技术得以应用，磁带替代了纸带，**监督程序控制自动从磁带中输入输出作业数据**，从而提高了输入输出速度。不过，此时内存中同一时刻只能有一道程序运行，程序之间串行执行。**多道批处理系统**的出现标志着操作系统的正式诞生，**支持多道程序并发运行**，多个程序共享计算机资源，提高了资源利用率。然而，多道批处理系统不提供人机交互功能，用户无法调试程序或输入参数。**分时操作系统**则以时间片为单位轮流为各个用户或作业服务，**允许用户通过键盘、鼠标等终端与计算机进行交互**，多个用户可以独立使用同一台计算机。尽管分时操作系统提升了用户体验，但它的缺点是无法优先处理紧急任务。**实时操作系统**根据任务**优先响应紧急任务**，分为硬实时和软实时操作系统。硬实时操作系统必须在规定时间内处理任务，否则会导致严重后果；而软实时操作系统虽不严格要求处理时间，但仍需实时显示更新信息。

此外，还有**网络操作系统、分布式操作系统和个人计算机操作系统**。网络操作系统用于管理网络资源并提供网络服务，分布式操作系统将多台计算机组成一个整体，共同完成任务，而个人计算机操作系统（如Windows、Linux等）则用于管理个人计算机的硬件和软件资源。



#### 操作系统的分类

**按照用户界面的使用环境和功能特征，分为三种：批处理系统、分时系统、实时系统**。

**Linux、UNIX系统属于多任务多用户，分时系统，是网络操作系统。**

##### 1. 批处理系统

用户将作业交给操作员，在收到一定数量的作业后，由操作员把这批作业输入到计算机，最后将结果交给用户。自动化较高，资源利用率高，作业吞吐量大，提高整个系统效率。用户不直接与计算机交互，不适合调试程序。

##### 2. 分时系统

用户通过终端交互式地向系统提出命令，系统接受命令之后，采用时间片轮转方式处理服务请求。把处理机的响应时间分成若干个大小相等的时间单位，称为时间片，每个终端用户获得 CPU，就等于获得一个时间片，该用户程序开始运行，当时间片到用完，用户程序暂停运行，等待下一次运行。

多个用户在同时使用一台计算机，用户感觉不到计算机为他人服务，系统能对用户提出的请求及时给予响应。

##### 3. 实时系统

实时系统是指系统能及时响应外部事件的请求，在规定的时间内，完成对该事件的处理，并控制所有实时任务协调一致地运行。

第一类：硬实时系统(实时过程控制)，工业控制，军事控制等。

第二类：软实时系统(实时通信和信息处理)，电讯(自动交换)，银行，飞机订票，股市行情等。

特征：多路性、独立性、及时性、交互性和可靠性。



### 操作系统的运行环境

#### 内核态与用户态

操作系统在计算机上运行，通过执行**二进制机器指令**来实现程序逻辑。对于使用高级语言编写的程序，它们需要经过编译器编译成机器指令，才能被CPU执行。**机器指令是CPU能够识别的基本命令**，负责执行加法、赋值等基本操作。

操作系统内核包含系统最核心、必不可少的功能。内核作为系统资源管理者，执行特权指令以管理硬件资源。特权指令的使用限于内核程序，应用程序不得使用。**操作系统内核程序负责系统资源管理，而应用程序运行在操作系统之上。内核程序使用特权指令，而应用程序使用非特权指令。**

**CPU有内核态和用户态两种状态，内核态执行特权指令，用户态执行非特权指令。程序状态寄存器（PSW）的二进制位标记CPU状态，1表示内核态，0表示用户态。内核态和用户态分别对应内核程序和应用程序的执行。**

1. **内核态**：在内核态下，程序可以执行任何CPU指令，并且可以直接访问硬件资源和系统内存。此时，操作系统内核拥有完全的控制权，能够进行进程管理、内存管理、设备管理等操作。
2. **用户态**：用户态是应用程序运行的模式，此时程序受到限制，不能直接访问硬件或管理系统资源。用户态下的程序只能执行有限的指令，并通过系统调用与内核进行交互。

**切换机制**：

- **用户态到内核态**：

  - **系统调用**：应用程序通过特定的API（如`open()`、`read()`等）进行系统调用，请求操作系统提供服务。此时，**程序会执行一个特定的指令（如`int`指令在x86架构上）触发中断**。
  - **异常或错误**：程序在执行过程中遇到异常（如非法操作、内存访问错误）时，操作系统会自动进入内核态进行处理。
  - **中断**：硬件设备（如定时器、I/O设备）发送中断信号，操作系统会中断当前用户程序，转入内核态进行相应的处理。

- **内核态到用户态**：

  - **服务完成**：内核完成对系统调用的处理，准备将结果返回给用户程序。

  - **调度**：在多进程环境中，内核可能选择另一个用户程序进行调度，这也需要切换回用户态。

这种切换机制通过上下文切换和特权指令的控制，确保了系统的安全性和稳定性，同时允许多种程序在同一台计算机上有效运行。



#### 中断、异常

**中断是操作系统内核重新夺回CPU使用权的唯一途径**。中断会使CPU由用户态变为内核态。没有中断技术无法实现多道程序并发，甚至没有操作系统。

**内中断又称异常**，与当前执行的指令有关。

- **非法指令或非法参数**会引发内中断。
- 应用程序**执行陷入指令**（以请求操作系统服务，陷入指令不是特权指令）。

外中断与当前执行的指令无关，来源于CPU外部。**CPU在每个指令执行结束后检查外部中断信号**。

- **时钟中断，实现多道程序并发运行**。
- **I/O设备发出中断信号**，通知CPU设备操作完成。

中断处理的基本流程如下：

1. **中断信号的产生**：当外设或程序需要CPU处理时，生成中断信号。
2. **中断检测**：CPU在每个指令周期结束时检查是否有中断信号。如果有，立即响应中断。
3. **保存上下文**：CPU保存当前执行程序的状态（上下文），包括程序计数器、寄存器等，以便在中断处理完成后能够恢复执行。
4. **中断向量**：CPU使用**中断向量表（中断向量是一组指向中断处理程序的指针）找到对应中断的处理程序地址**。
5. **执行中断处理程序**：CPU跳转到中断处理程序执行，处理相关的事件或任务。
6. **恢复上下文**：中断处理完成后，CPU恢复之前保存的上下文。
7. **返回原程序**：CPU继续执行之前被中断的程序，恢复正常运行。



#### 系统调用





### 操作系统体系结构



## 进程管理

### 进程与线程 

#### 进程概念



#### 进程的状态与转换



#### 进程控制



#### 进程组织



#### 进程通信 



##### 共享存储系统



##### 消息传递系统



##### 管道通信



#### 线程概念与多线程模型

### 处理机调度 

#### 调度的基本概念



#### 调度时机、切换与过程



#### 度的基本准则



#### 调度方式



#### 典型调度算法 

##### 先来先服务调度算法



##### 短作业(短进程、短线程)优先调度算法



##### 时间片轮转调度算法



##### 优先级调度算法



##### 高响应比优先调度算法



##### 多级反馈队列调度算法



### 同步与互斥

#### 进程同步的基本概念



#### 实现临界区互斥的基本方法

##### 软件实现方法



##### 硬件实现方法



#### 信号量



#### 管程



#### 经典同步问题

##### 生产者-消费者问题



##### 读者-写者问题



##### 哲学家进餐问题



### 死锁 

#### 死锁的概念

**死锁**：是指多个进程因竞争资源而造成的一种僵局现象，若无外力的作用，这些进程都不能继续执行。死锁进程至少有两个。

死锁的原因：

1. 竞争资源。当系统中供多个进程共享的资源不足以同时满足它们的需求时，引起它们对资源的竞争而产生死锁。
2. 进程推进顺序不合理。进程在运行过程中，请求和释放资源的顺序不当，会导致进程死锁。

**活锁**：是指数据资源释放时间不确定，导致某些事务长时间等待，得不到封锁的机会。

**饥饿**：是指系统没有发生死锁，但某些进程可能会长时间等待，当等待时间给进程推进和响应带来明显影响时，称进程饥饿。



#### 死锁处理策略



#### 死锁预防



#### 死锁避免

##### 系统安全状态



##### 银行家算法



#### 死锁检测和解除



## 内存管理

### 内存管理基础 

#### 内存管理概念 

##### 程序装入与链接

**计算机系统中的存储器可分成两类：内存、外存**。

**处理器可以直接访问内存，但不能直接访问外存**。CPU要通过启动相应的I/0设备后才能使外存与内存交换信息。内存管理是操作系统的重要功能之一，对内存管理的好坏直接影响计算机系统工作性能的高低。

存储系统三要素：容量、速度、成本。



##### 逻辑地址与物理地址空间



##### 内存保护



#### 交换与覆盖



#### 连续分配管理方式



#### 非连续分配管理方式

##### 分页管理方式



##### 分段管理方式



##### 段页式管理方式



### 虚拟内存管理 

#### 虚拟内存基本概念



#### 请求分页管理方式



#### 页面置换算法

##### 最佳置换算法(OPT)



##### 先进先出置换算法(FIFO)



##### 最近最少使用置换算法(LRU)



##### 时钟置换算法(CLOCK)



#### 页面分配策略



#### 工作集



#### 抖动



## 文件管理

### 文件系统基础

#### 文件概念

操作系统必须提供的数据存储、数据处理、数据管理的基本功能，这些功能都是以文件形式进行处理和管理的。文件系统是操作系统的一个重要组成部分。

文件是指存放在存储介质上的已命名的一组相关信息的集合，通常将程序和数据组织成文件。文件中的基本访问单位是位、字节或记录。文件的属性包括文件类型、文件长度、文件的物理位置、文件的存取控制、文件的建立时间。文件是一种抽象机制，它提供了一种把信息保存在存储介质上而且便于以后存取的方法，用户不用关心文件的实现细节。

文件系统是操作系统中统一管理信息资源的一种软件。它管理文件的存储、检索、更新，提供安全可靠的共享和保护手段，并且方便用户使用。从用户的角度，**文件系统实现“按名存取”，通过文件目录查找**，主要关心文件由什么组成，如何命名，如何保护，如何操作等。

对不同的文件进行分类管理，提高系统效率，同时提高文件系统的用户界面友好性。

按文件的用途分类：系统文件、库函数文件、用户文件。

按文件的组织形式分类：普通文件、目录文件、特殊文件。

按文件中的保护方式分类：只读文件、读写文件、可执行文件、无保护文件等。

按照文件的组织结构分类：

- **逻辑结构：无结构的流式文件和有结构的记录式文件。**
- **物理结构：顺序文件、链接文件和索引文件。**



文件目录是指存放文件有关信息的一种数据结构。它包含多条记录，每条记录为一个文件的**文件控制块(FCB)**的有关信息。最简单的记录包含文件名和文件的起始地址，用以建立文件名和存储地址的对应关系。文件目录是文件实现按名存取的重要手段，是文件符号名到文件物理地址之间的一种映射机制。
文件控制块FCB:是文件存在的标志，记录了系统管理文件所需要的全部信息，包括**文件名**、文件号、用户名、文件物理地址、文件长度、记录大小、文件类型、文件属性、共享说明、文件逻辑结构、物理结构、文件的建立时间、最后访问时间、最后修改时间、保存期限、口令等。

**操作系统通过 FCB 文件管理** 

操作系统通过 PCB 进程管理 



Windows系统中，用户A对一个文件有读、写的权限，而A对于这个文件所在的文件夹只有读权限，用户A最终对这个文件将具备读权限。

数字表示不同用户或用户组的权限。第一个数字代表档案拥有者，第二个数字代表群组，第三个数字代表其他。在Linux中我们有三种常用权限：可读、可写以及可执行，用数字表示的话就是：可读=4，可写=2，可执行=1。



文件保护是指避免由于自然灾祸、系统故障、用户使用不当等原因使文件遭到破坏或丢失的现象。文件系统通常采用**建立副本、定时转储、规定文件的存储权限**的方法保护文件。

文件保密是指文件本身不得被未授权的用户访问，即防止他人窃取文件。实现文件保密采用的方法有：隐藏文件目录、设置口令、文件加密。



#### 文件的逻辑结构

 ##### 顺序文件



##### 索引文件



##### 索引顺序文件



#### 目录结构 

##### 文件控制块和索引节点



##### 单级目录结构和两级目录结构



##### 树形目录结构



##### 图形目录结构



#### 文件共享 



#### 文件保护

##### 访问类型



##### 访问控制



### 文件系统实现

#### 文件系统层次结构



#### 目录实现



#### 文件实现



### 磁盘组织与管理 

#### 磁盘的结构



#### 磁盘调度算法



#### 磁盘的管理



## 输入输出(I/O)管理

### I/O 管理概述

#### I/O 控制方式



#### I/O 软件层次结构



### I/O 核心子系统

#### I/O 调度概念



#### 高速缓存与缓冲区



#### 设备分配与回收



#### 假脱机技术